version: "3.9"

services:
  gateway:
    build:
      context: ./gateway
    ports:
      - "8000:8000"
    depends_on:
      - inference_service
      - user_service

  inference_service:
    build:
      context: ./inference_service
    ports:
      - "8001:8001"
    depends_on:
      - rag_service
      - user_service
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}

  rag_service:
    build:
      context: ./rag_service
    ports:
      - "8002:8002"
    depends_on:
      - weaviate
    environment:
      GITHUB_ACTIONS: false  # or true if running in CI

  user_service:
    build:
      context: ./user_service
    ports:
      - "8003:8003"
    depends_on:
      - postgres
    environment:
      AUTH_DATABASE_URL: postgres://postgres:password@postgres:5432/authdb
      AUTH_SECRET_KEY: ${AUTH_SECRET_KEY}
      AUTH_ALGORITHM: ${AUTH_ALGORITHM}

  postgres:
    image: postgres:16
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: authdb
    ports:
      - "5432:5432"

  weaviate:
    image: cr.weaviate.io/semitechnologies/weaviate:1.27.0
    restart: always
    ports:
      - "8080:8080"
      - "50051:50051"
    environment:
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"
      PERSISTENCE_DATA_PATH: "/var/lib/weaviate"
      DEFAULT_VECTORIZER_MODULE: none
      ENABLE_MODULES: ""
